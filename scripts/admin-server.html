<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radar de Tendências - Admin</title>
  
  <!-- jQuery primeiro! -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- Bootstrap CSS e JS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <style>
    .card-header {
      font-weight: bold;
    }
    .status-ativo {
      color: green;
      font-weight: bold;
    }
    .status-inativo {
      color: red;
    }
    
    /* Estilos para o Kanban */
    .kanban-column {
      margin-bottom: 20px;
    }
    
    .kanban-cards {
      min-height: 300px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .kanban-card {
      margin-bottom: 10px;
      cursor: pointer;
      border-left: 4px solid #6c757d;
    }
    
    .kanban-card-novo {
      border-left-color: #17a2b8;
    }
    
    .kanban-card-onboarding {
      border-left-color: #ffc107;
    }
    
    .kanban-card-ativo {
      border-left-color: #28a745;
    }
    
    .kanban-card-inativo {
      border-left-color: #6c757d;
    }
    
    .kanban-card-dragging {
      opacity: 0.5;
    }
    
    .kanban-card-header {
      padding: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .kanban-card-body {
      padding: 8px;
      font-size: 12px;
    }
    
    .kanban-card-footer {
      padding: 5px 8px;
      background-color: #f8f9fa;
      font-size: 11px;
      color: #6c757d;
      display: flex;
      justify-content: space-between;
    }
    
    .kanban-card .dropdown-menu {
      min-width: 150px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-radar"></i> Radar de Tendências - Painel Administrativo
      </a>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Tabs para navegação -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="usuarios-tab" data-toggle="tab" href="#usuarios" role="tab">Usuários</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="conteudos-tab" data-toggle="tab" href="#conteudos" role="tab">Conteúdos Gerados</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="kanban-tab" data-toggle="tab" href="#kanban" role="tab">Kanban de Jornada</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="dashboards-tab" data-toggle="tab" href="#dashboards" role="tab">Dashboards AWS</a>
      </li>
    </ul>
    
    <!-- Conteúdo das tabs -->
    <div class="tab-content" id="adminTabsContent">
      <!-- Tab de Usuários -->
      <div class="tab-pane fade show active" id="usuarios" role="tabpanel">
        <div class="card mt-3">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Usuários Registrados</h5>
            <button class="btn btn-sm btn-light" id="refreshUsuarios">Atualizar Dados</button>
          </div>
          <div class="card-body">
            <div id="userStats" class="mb-3">
              <div class="alert alert-info">Carregando estatísticas...</div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered" id="usuariosTable">
                <thead class="thead-dark">
                  <tr>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>Status</th>
                    <th>Data Cadastro</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="usuariosTableBody">
                  <tr>
                    <td colspan="5" class="text-center">Carregando usuários...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tab de Conteúdos -->
      <div class="tab-pane fade" id="conteudos" role="tabpanel">
        <div class="card mt-3">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Conteúdos Gerados</h5>
            <button class="btn btn-sm btn-light" id="refreshConteudos">Atualizar Dados</button>
          </div>
          <div class="card-body">
            <div id="conteudosStats" class="mb-3">
              <div class="alert alert-info">Carregando estatísticas...</div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered" id="conteudosTable">
                <thead class="thead-dark">
                  <tr>
                    <th>ID</th>
                    <th>Tipo</th>
                    <th>Usuário</th>
                    <th>Data Criação</th>
                    <th>Conteúdo</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="conteudosTableBody">
                  <tr>
                    <td colspan="6" class="text-center">Carregando conteúdos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tab de Kanban -->
      <div class="tab-pane fade" id="kanban" role="tabpanel">
        <div class="card mt-3">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Kanban de Jornada do Usuário</h5>
            <button class="btn btn-sm btn-light" id="refreshKanban">
              <i class="fas fa-sync-alt"></i> Atualizar
            </button>
          </div>
          <div class="card-body">
            <!-- Filtro e legenda -->
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="Filtrar usuários..." id="kanbanFilter">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="applyFilter">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6 text-right">
                <span class="badge badge-primary">Total: <span id="kanbanTotalUsuarios">0</span></span>
              </div>
            </div>
            
            <!-- Quadro Kanban -->
            <div class="kanban-board">
              <div class="row">
                <!-- Coluna: Novo -->
                <div class="col-md-3 kanban-column">
                  <div class="card">
                    <div class="card-header bg-info text-white">
                      Novos <span class="badge badge-light" id="count-novos">0</span>
                    </div>
                    <div class="card-body kanban-cards" id="kanban-novos">
                      <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Coluna: Em Onboarding -->
                <div class="col-md-3 kanban-column">
                  <div class="card">
                    <div class="card-header bg-warning text-white">
                      Em Onboarding <span class="badge badge-light" id="count-onboarding">0</span>
                    </div>
                    <div class="card-body kanban-cards" id="kanban-onboarding">
                      <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Coluna: Em Progresso -->
                <div class="col-md-3 kanban-column">
                  <div class="card">
                    <div class="card-header bg-success text-white">
                      Em Progresso <span class="badge badge-light" id="count-em-progresso">0</span>
                    </div>
                    <div class="card-body kanban-cards" id="kanban-em-progresso">
                      <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Coluna: Concluído -->
                <div class="col-md-3 kanban-column">
                  <div class="card">
                    <div class="card-header bg-secondary text-white">
                      Concluído <span class="badge badge-light" id="count-concluido">0</span>
                    </div>
                    <div class="card-body kanban-cards" id="kanban-concluido">
                      <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para detalhes -->
  <div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Detalhes</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Conteúdo dinâmico aqui -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Adicione isso logo após o elemento body -->
  <div id="debug-info" style="position: fixed; bottom: 0; right: 0; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; max-width: 400px; max-height: 200px; overflow: auto; z-index: 9999; font-size: 12px; display: none;">
    <h6><i class="fas fa-bug"></i> Informações de Depuração</h6>
    <div id="debug-content"></div>
  </div>

  <!-- Verificação de jQuery - adicionado após o jQuery e antes dos outros scripts -->
  <script>
    // Verificar se jQuery está disponível
    if (typeof jQuery === 'undefined') {
      console.error('ERRO CRÍTICO: jQuery não está carregado!');
      document.body.innerHTML = '<div style="padding: 20px; background-color: #f8d7da; color: #721c24; margin: 20px;">ERRO: jQuery não foi carregado corretamente. Por favor, recarregue a página ou contate o suporte.</div>';
    } else {
      console.log('jQuery carregado corretamente! Versão:', $.fn.jquery);
    }
  </script>
  
  <!-- Outros scripts após a verificação -->
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!-- Substitua o script principal pelo seguinte -->
  <script>
    // Utilitário de depuração
    const Debug = {
      show: function() {
        $('#debug-info').show();
      },
      log: function(message) {
        console.log(message);
        $('#debug-content').append(`<div>${message}</div>`);
        this.show();
      },
      error: function(message, error) {
        console.error(message, error);
        $('#debug-content').append(`<div style="color: red"><strong>ERRO:</strong> ${message}</div>`);
        if (error) {
          $('#debug-content').append(`<div style="color: red; font-family: monospace;">${JSON.stringify(error)}</div>`);
        }
        this.show();
      },
      clear: function() {
        $('#debug-content').empty();
      }
    };

    $(document).ready(function() {
      // Botão de depuração (descomente para ativar)
      $('body').append('<button id="debug-toggle" style="position: fixed; bottom: 10px; right: 10px; z-index: 9999;">Debug</button>');
      $('#debug-toggle').click(function() {
        $('#debug-info').toggle();
      });
      
      Debug.log('Inicializando admin panel na versão jQuery: ' + $.fn.jquery);
      
      // ===== INÍCIO DA IMPLEMENTAÇÃO DE DRAG AND DROP =====
      
      // Função para inicializar o drag and drop
      function setupDragAndDrop() {
        // Remover quaisquer handlers anteriores para evitar duplicação
        $(document).off('dragstart', '.kanban-card');
        $(document).off('dragover', '.kanban-cards');
        $(document).off('drop', '.kanban-cards');
        $(document).off('dragend', '.kanban-card');
        
        // Aplicar atributo draggable aos cartões
        $('.kanban-card').attr('draggable', 'true');
        
        // Quando começa a arrastar um cartão
        $(document).on('dragstart', '.kanban-card', function(event) {
          const dataTransfer = event.originalEvent.dataTransfer;
          
          // Armazenar o ID do usuário e a coluna de origem
          const card = $(this);
          const usuarioId = card.data('id');
          const origemColuna = card.closest('.kanban-cards').attr('id').replace('kanban-', '');
          
          dataTransfer.setData('text/plain', JSON.stringify({
            usuarioId: usuarioId,
            origem: origemColuna
          }));
          
          // Adicionar classe visual para feedback
          card.addClass('kanban-card-dragging');
          
          Debug.log(`Começou a arrastar o cartão: ${usuarioId} da coluna: ${origemColuna}`);
        });
        
        // Evento para permitir soltar em uma coluna
        $(document).on('dragover', '.kanban-cards', function(event) {
          // Prevenir comportamento padrão para permitir soltar
          event.preventDefault();
          event.originalEvent.dataTransfer.dropEffect = 'move';
        });
        
        // Quando solta um cartão em outra coluna
        $(document).on('drop', '.kanban-cards', function(event) {
          event.preventDefault();
          
          try {
            // Obter dados do cartão arrastado
            const dataTransfer = event.originalEvent.dataTransfer;
            const dataString = dataTransfer.getData('text/plain');
            const data = JSON.parse(dataString);
            
            // Obter a coluna de destino
            const destinoColuna = $(this).attr('id').replace('kanban-', '');
            const origemColuna = data.origem;
            const usuarioId = data.usuarioId;
            
            Debug.log(`Soltou o cartão: ${usuarioId} da coluna: ${origemColuna} para coluna: ${destinoColuna}`);
            
            // Se origem e destino forem iguais, não faz nada
            if (origemColuna === destinoColuna) {
              return;
            }
            
            // Mover o cartão visualmente para a nova coluna
            const $card = $(`.kanban-card[data-id="${usuarioId}"]`);
            $(this).append($card);
            
            // Atualizar visualmente a classe do cartão para o novo estágio
            $card.removeClass(`kanban-card-${origemColuna}`).addClass(`kanban-card-${destinoColuna}`);
            
            // Atualizar contadores
            updateKanbanCounters();
            
            // Enviar ao backend a atualização
            updateUsuarioEstagio(usuarioId, destinoColuna);
          } catch (error) {
            Debug.error('Erro ao processar o drop:', error);
          }
        });
        
        // Quando termina o drag (seja com sucesso ou cancelado)
        $(document).on('dragend', '.kanban-card', function() {
          // Remover a classe visual
          $(this).removeClass('kanban-card-dragging');
        });
      }
      
      // Função para atualizar o estágio do usuário no backend
      function updateUsuarioEstagio(usuarioId, novoEstagio) {
        if (!usuarioId) {
          Debug.error('ID do usuário não disponível para atualização');
          return;
        }
        
        $.ajax({
          url: `/api/usuarios/${usuarioId}/estagio`,
          method: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify({ novoEstagio: novoEstagio }),
          success: function(response) {
            Debug.log(`Usuário ${usuarioId} atualizado com sucesso para ${novoEstagio}`);
            
            // Mostrar notificação de sucesso
            const notification = $(`<div class="alert alert-success alert-dismissible fade show" role="alert">
              Usuário movido com sucesso para ${novoEstagio}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>`);
            
            $('#kanban .card-header').after(notification);
            
            // Auto-remover a notificação após 3 segundos
            setTimeout(() => {
              notification.alert('close');
            }, 3000);
          },
          error: function(xhr, status, error) {
            const errorMsg = xhr.responseJSON?.error || error || 'Erro desconhecido';
            Debug.error(`Erro ao atualizar o estágio do usuário ${usuarioId}`, { status, error: errorMsg });
            
            // Notificação de erro (permanente, precisa fechar manualmente)
            const notification = $(`<div class="alert alert-danger alert-dismissible fade show" role="alert">
              Erro ao mover o usuário: ${errorMsg}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>`);
            
            $('#kanban .card-header').after(notification);
          }
        });
      }
      
      // Função para atualizar os contadores de cartões em cada coluna
      function updateKanbanCounters() {
        // Atualizar contadores de cada coluna
        ['novos', 'onboarding', 'em-progresso', 'concluido'].forEach(coluna => {
          const count = $(`#kanban-${coluna} .kanban-card`).length;
          $(`#count-${coluna}`).text(count);
        });
        
        // Atualizar contador total
        const totalCards = $('.kanban-card').length;
        $('#kanbanTotalUsuarios').text(totalCards);
      }
      
      // ===== FIM DA IMPLEMENTAÇÃO DE DRAG AND DROP =====
      
      // Funções para carregar dados DEFINIDAS PRIMEIRO - Corrigindo o ReferenceError
      function loadUsuarios() {
        $('#usuariosTableBody').html('<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando usuários...</td></tr>');
        $('#userStats').html('<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Carregando estatísticas...</div>');
        
        console.log('Iniciando carregamento de usuários...');
        
        $.ajax({
          url: '/api/usuarios',
          method: 'GET',
          timeout: 10000,
          success: function(data) {
            console.log(`Dados de usuários carregados: ${data.count} usuários`);
            
            // Armazenar os dados para referência posterior
            window.usuariosData = data;
            
            // Atualizar estatísticas
            $('#userStats').html(`
              <div class="row">
                <div class="col-md-4">
                  <div class="card bg-info text-white">
                    <div class="card-body">
                      <h5 class="card-title">Total de Usuários</h5>
                      <p class="card-text display-4">${data.count}</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bg-success text-white">
                    <div class="card-body">
                      <h5 class="card-title">Usuários Ativos</h5>
                      <p class="card-text display-4">${data.ativos || 0}</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="alert alert-secondary">
                    <strong>Tabela DynamoDB:</strong> ${data.table || 'Não informada'}
                  </div>
                </div>
              </div>
            `);
            
            // Limpar tabela
            $('#usuariosTableBody').empty();
            
            // Verificar se temos usuários
            if (data.usuarios.length === 0) {
              $('#usuariosTableBody').html('<tr><td colspan="5" class="text-center">Nenhum usuário encontrado</td></tr>');
              return;
            }
            
            // Preencher tabela com usuários
            data.usuarios.forEach(function(usuario, index) {
              const dataFormatada = new Date(usuario.dataCadastro || usuario.createdAt || Date.now()).toLocaleString('pt-BR');
              
              // Determinar o status do usuário
              let status = 'desconhecido';
              let statusClass = '';
              
              // Verificar todas as possíveis propriedades que indicam status
              if (usuario.status === 'ativo' || usuario.status === 'active' || 
                  usuario.situacao === 'ativo' || usuario.situacao === 'active' || 
                  usuario.ativo === true || usuario.active === true) {
                status = 'ativo';
                statusClass = 'status-ativo';
              } else if (usuario.status === 'inativo' || usuario.status === 'inactive' || 
                        usuario.situacao === 'inativo' || usuario.situacao === 'inactive' || 
                        usuario.ativo === false || usuario.active === false) {
                status = 'inativo';
                statusClass = 'status-inativo';
              }
              
              // Obter campos principais
              const nome = usuario.nome || usuario.name || usuario.nomeCompleto || '—';
              const telefone = usuario.telefone || usuario.whatsapp || usuario.phone || usuario.phoneNumber || '—';
              // Tentar obter o ID do usuário de todos os campos possíveis
              const usuarioId = usuario.id || usuario.usuarioId || usuario.userId || 
                               usuario.telefone || usuario.phoneNumber || usuario.whatsapp || 
                               usuario._id || usuario.uid || '';
              
              // Log para depuração dos IDs
              if (!usuarioId) {
                console.warn('Usuário sem ID encontrado:', JSON.stringify(usuario));
              }
              
              $('#usuariosTableBody').append(`
                <tr>
                  <td>${nome}</td>
                  <td>${telefone}</td>
                  <td><span class="${statusClass}">${status}</span></td>
                  <td>${dataFormatada}</td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button class="btn btn-info viewUserDetails" data-index="${index}">
                        <i class="fas fa-eye"></i> Ver
                      </button>
                      ${usuarioId ? 
                      `<button class="btn btn-danger removeUser" data-index="${index}" data-id="${usuarioId}" data-nome="${nome}">
                        <i class="fas fa-trash"></i> Remover
                      </button>` : 
                      `<button class="btn btn-secondary" disabled title="ID não disponível para este usuário">
                        <i class="fas fa-trash"></i> Remover
                      </button>`}
                    </div>
                  </td>
                </tr>
              `);
            });
          },
          error: function(xhr, status, error) {
            const errorMsg = xhr.responseJSON?.error || error || status;
            console.error(`Erro ao carregar usuários: ${errorMsg}`, { xhr: xhr.status, status, error });
            
            $('#userStats').html(`<div class="alert alert-danger">
              <h5><i class="fas fa-exclamation-triangle"></i> Erro ao carregar estatísticas</h5>
              <p>${errorMsg}</p>
              <p>Status: ${status}, Código: ${xhr.status}</p>
            </div>`);
            
            $('#usuariosTableBody').html(`
              <tr>
                <td colspan="5" class="text-center text-danger">
                  <p><i class="fas fa-exclamation-circle"></i> Erro ao carregar usuários: ${errorMsg}</p>
                  <button class="btn btn-sm btn-primary retry-load-users">Tentar Novamente</button>
                </td>
              </tr>
            `);
            
            $('.retry-load-users').on('click', loadUsuarios);
          }
        });
      }

      function loadConteudos() {
        $('#conteudosTableBody').html('<tr><td colspan="6" class="text-center">Carregando conteúdos...</td></tr>');
        $('#conteudosStats').html('<div class="alert alert-info">Carregando estatísticas...</div>');
        
        $.ajax({
          url: '/api/conteudos',
          method: 'GET',
          success: function(data) {
            // Armazenar dados para referência
            window.conteudosData = data;
            
            // Atualizar estatísticas
            $('#conteudosStats').html(`
              <div class="row">
                <div class="col-md-4">
                  <div class="card bg-info text-white">
                    <div class="card-body">
                      <h5 class="card-title">Total de Conteúdos</h5>
                      <p class="card-text display-4">${data.count}</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-8">
                  <div class="alert alert-secondary">
                    <strong>Tabela DynamoDB:</strong> ${data.table}
                  </div>
                </div>
              </div>
            `);
            
            // Limpar tabela
            $('#conteudosTableBody').empty();
            
            // Verificar se temos conteúdos
            if (data.conteudos.length === 0) {
              $('#conteudosTableBody').html('<tr><td colspan="6" class="text-center">Nenhum conteúdo encontrado</td></tr>');
              return;
            }
            
            // Preencher tabela com conteúdos
            data.conteudos.forEach(function(conteudo, index) {
              const dataFormatada = new Date(conteudo.dataCriacao || conteudo.timestamp || Date.now()).toLocaleString('pt-BR');
              const conteudoTexto = conteudo.texto || conteudo.conteudo || conteudo.mensagem || JSON.stringify(conteudo);
              const previewContent = conteudoTexto.length > 100 ? conteudoTexto.substring(0, 100) + '...' : conteudoTexto;
              
              $('#conteudosTableBody').append(`
                <tr>
                  <td>${conteudo.id || conteudo.conteudoId || '—'}</td>
                  <td>${conteudo.tipo || conteudo.tipoConteudo || '—'}</td>
                  <td>${conteudo.usuarioId || conteudo.telefone || '—'}</td>
                  <td>${dataFormatada}</td>
                  <td>${previewContent}</td>
                  <td>
                    <button class="btn btn-sm btn-info viewConteudoDetails" data-index="${index}">
                      <i class="fas fa-eye"></i> Ver
                    </button>
                  </td>
                </tr>
              `);
            });
          },
          error: function(err) {
            $('#conteudosStats').html(`<div class="alert alert-danger">Erro ao carregar estatísticas: ${err.responseJSON?.error || err.statusText}</div>`);
            $('#conteudosTableBody').html(`<tr><td colspan="6" class="text-center text-danger">Erro ao carregar conteúdos: ${err.responseJSON?.error || err.statusText}</td></tr>`);
          }
        });
      }
      
      function loadDashboards() {
        $('#dashboardsList').html(`
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Carregando...</span>
            </div>
            <p>Carregando dashboards...</p>
          </div>
        `);
        
        $.ajax({
          url: '/api/dashboards',
          method: 'GET',
          success: function(data) {
            $('#dashboardsList').empty();
            
            if (data.dashboards.length === 0) {
              $('#dashboardsList').html('<div class="alert alert-warning">Nenhum dashboard encontrado no CloudWatch</div>');
              return;
            }
            
            data.dashboards.forEach(function(dashboard) {
              $('#dashboardsList').append(`
                <a href="${dashboard.url}" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-chart-line mr-2"></i>
                    ${dashboard.name}
                  </div>
                  <span class="badge badge-primary badge-pill">Abrir <i class="fas fa-external-link-alt ml-1"></i></span>
                </a>
              `);
            });
            
            // Adicionar link para o dashboard principal
            const region = data.region || 'us-east-1';
            $('#dashboardsList').append(`
              <a href="https://console.aws.amazon.com/cloudwatch/home?region=${region}#dashboards:name=RadarTendenciasDashboard" 
                 target="_blank" class="list-group-item list-group-item-action list-group-item-primary d-flex justify-content-between align-items-center">
                <div>
                  <i class="fas fa-star mr-2"></i>
                  RadarTendenciasDashboard (Principal)
                </div>
                <span class="badge badge-primary badge-pill">Abrir <i class="fas fa-external-link-alt ml-1"></i></span>
              </a>
            `);
          },
          error: function(err) {
            console.error('Erro ao carregar dashboards:', err);
            $('#dashboardsList').html(`<div class="alert alert-danger">
              Erro ao carregar dashboards: ${err.responseJSON?.error || err.statusText || 'Erro desconhecido'}
            </div>`);
          }
        });
      }
      
      function loadKanban() {
        // Limpar e mostrar indicador de carregamento
        ['novos', 'onboarding', 'em-progresso', 'concluido'].forEach(function(coluna) {
          $(`#kanban-${coluna}`).html('<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>');
          $(`#count-${coluna}`).text('0');
        });
        
        // Carregar dados dos usuários
        $.ajax({
          url: '/api/usuarios',
          method: 'GET',
          success: function(data) {
            // Armazenar dados para referência
            window.kanbanData = data;
            
            // Contar total de usuários
            $('#kanbanTotalUsuarios').text(data.count);
            
            // Agrupar usuários por estágio
            const novos = [];
            const emOnboarding = [];
            const emProgresso = [];
            const concluido = [];
            
            data.usuarios.forEach(function(usuario) {
              const estagio = determinarEstagioUsuario(usuario);
              
              switch(estagio) {
                case 'novo':
                  novos.push(usuario);
                  break;
                case 'onboarding':
                  emOnboarding.push(usuario);
                  break;
                case 'ativo':
                  emProgresso.push(usuario);
                  break;
                case 'inativo':
                  concluido.push(usuario);
                  break;
              }
            });
            
            // Atualizar contadores
            $('#count-novos').text(novos.length);
            $('#count-onboarding').text(emOnboarding.length);
            $('#count-em-progresso').text(emProgresso.length);
            $('#count-concluido').text(concluido.length);
            
            // Limpar colunas
            ['novos', 'onboarding', 'em-progresso', 'concluido'].forEach(function(coluna) {
              $(`#kanban-${coluna}`).empty();
            });
            
            // Preencher colunas
            renderizarColuna('#kanban-novos', novos, 'novo');
            renderizarColuna('#kanban-onboarding', emOnboarding, 'onboarding');
            renderizarColuna('#kanban-em-progresso', emProgresso, 'ativo');
            renderizarColuna('#kanban-concluido', concluido, 'inativo');
            
            // Configurar drag and drop
            setupDragAndDrop();
            
            // Atualizar contadores visuais
            updateKanbanCounters();
          },
          error: function(err) {
            ['novos', 'onboarding', 'em-progresso', 'concluido'].forEach(function(coluna) {
              $(`#kanban-${coluna}`).html(
                `<div class="alert alert-danger">Erro ao carregar dados: ${err.responseJSON?.error || err.statusText || 'Erro desconhecido'}</div>`
              );
            });
          }
        });
      }
      
      // Função para determinar o estágio do usuário
      function determinarEstagioUsuario(usuario) {
        // Verificar se tem campo de estágio explícito
        if (usuario.estagio) {
          const estagioLower = usuario.estagio.toLowerCase();
          
          // Mapear para os estágios do kanban
          if (estagioLower === 'novo') return 'novo';
          if (estagioLower === 'onboarding') return 'onboarding';
          if (estagioLower === 'ativo' || estagioLower === 'em_progresso' || estagioLower === 'em-progresso') return 'ativo';
          if (estagioLower === 'inativo' || estagioLower === 'concluido') return 'inativo';
        }
        
        if (usuario.onboardingStatus === 'concluido' && 
            (usuario.status === 'ativo' || usuario.ativo === true)) {
          return 'ativo';
        }
        
        if (usuario.onboardingStatus === 'em_andamento' || 
            usuario.onboardingEtapa > 0) {
          return 'onboarding';
        }
        
        // Se tem data de cadastro recente (últimos 7 dias) e não tem interações, é novo
        const dataAtual = new Date();
        const dataCadastro = new Date(usuario.dataCadastro || usuario.createdAt || 0);
        const diasDesdeRegistro = Math.floor((dataAtual - dataCadastro) / (1000 * 60 * 60 * 24));
        
        if (diasDesdeRegistro <= 7 && !usuario.ultimaInteracao) {
          return 'novo';
        }
        
        // Verificar se está inativo
        if (usuario.status === 'inativo' || usuario.ativo === false) {
          return 'inativo';
        }
        
        // Verificar última interação (se não teve interação nos últimos 30 dias, está inativo)
        if (usuario.ultimaInteracao) {
          const dataUltimaInteracao = new Date(usuario.ultimaInteracao);
          const diasDesdeUltimaInteracao = Math.floor((dataAtual - dataUltimaInteracao) / (1000 * 60 * 60 * 24));
          
          if (diasDesdeUltimaInteracao > 30) {
            return 'inativo';
          }
        }
        
        // Usuário já iniciou a jornada, parece ser ativo
        if (usuario.ultimaInteracao || usuario.onboardingStatus === 'concluido') {
          return 'ativo';
        }
        
        // Se nada corresponde, consideramos como novo
        return 'novo';
      }
      
      // Função para renderizar uma coluna do Kanban
      function renderizarColuna(selector, usuarios, estagio) {
        const $coluna = $(selector);
        
        if (usuarios.length === 0) {
          $coluna.html('<div class="text-center text-muted">Nenhum usuário neste estágio</div>');
          return;
        }
        
        // Ordenar por data de cadastro (mais recente primeiro)
        usuarios.sort((a, b) => {
          const dataA = new Date(a.dataCadastro || a.createdAt || 0);
          const dataB = new Date(b.dataCadastro || b.createdAt || 0);
          return dataB - dataA;
        });
        
        // Limpar coluna
        $coluna.empty();
        
        // Adicionar cartões para cada usuário
        usuarios.forEach(usuario => {
          const nome = usuario.nome || usuario.name || 'Sem nome';
          const telefone = usuario.telefone || usuario.whatsapp || 'Sem telefone';
          const dataCadastro = new Date(usuario.dataCadastro || usuario.createdAt || Date.now()).toLocaleDateString('pt-BR');
          const ultimaInteracao = usuario.ultimaInteracao 
            ? new Date(usuario.ultimaInteracao).toLocaleDateString('pt-BR')
            : 'Nenhuma';
          
          // Informação adicional baseada no estágio
          let infoAdicional = '';
          if (estagio === 'onboarding') {
            const etapa = usuario.onboardingEtapa || 0;
            infoAdicional = `<div><small>Etapa: ${etapa}</small></div>`;
          } else if (estagio === 'ativo') {
            const numInteracoes = usuario.totalInteracoes || 0;
            infoAdicional = `<div><small>Interações: ${numInteracoes}</small></div>`;
          }
          
          // Criar o cartão
          const card = `
            <div class="card kanban-card kanban-card-${estagio}" data-id="${usuario.id || usuario.usuarioId || ''}" draggable="true">
              <div class="kanban-card-header">
                <strong>${nome}</strong>
                <span class="badge badge-secondary">${telefone}</span>
              </div>
              <div class="kanban-card-body">
                ${infoAdicional}
              </div>
              <div class="kanban-card-footer">
                <small>Cadastro: ${dataCadastro}</small>
                <small>Últ. interação: ${ultimaInteracao}</small>
              </div>
            </div>
          `;
          
          $coluna.append(card);
        });
        
        // Configurar drag and drop após renderizar os cartões
        setupDragAndDrop();
      }
      
      // Verificar servidor ativo
      $.ajax({
        url: '/api/health',
        method: 'GET',
        timeout: 5000,
        success: function(data) {
          console.log('Servidor respondendo:', JSON.stringify(data));
          initializeApp();
        },
        error: function(xhr, status, error) {
          console.error('Servidor não está respondendo corretamente', { xhr: xhr.status, status, error });
          showServerError();
        }
      });
      
      function showServerError() {
        $('main .container').prepend(`
          <div class="alert alert-danger mt-4">
            <h4><i class="fas fa-exclamation-triangle"></i> Erro de Comunicação com o Servidor</h4>
            <p>Não foi possível conectar ao servidor local. Verifique se:</p>
            <ul>
              <li>O servidor está em execução através do script <code>executar-admin.sh</code></li>
              <li>Não há outros serviços utilizando a mesma porta</li>
              <li>O firewall não está bloqueando a conexão</li>
            </ul>
            <button class="btn btn-primary" id="retry-connection">Tentar Novamente</button>
          </div>
        `);
        
        $('#retry-connection').click(function() {
          location.reload();
        });
      }
      
      function initializeApp() {
        // Carregar dados iniciais
        loadUsuarios();
        
        // Registrar eventos para as abas
        $('#conteudos-tab').on('click', function() {
          if (!window.conteudosLoaded) {
            loadConteudos();
            window.conteudosLoaded = true;
          }
        });
        
        $('#dashboards-tab').on('click', function() {
          if (!window.dashboardsLoaded) {
            loadDashboards();
            window.dashboardsLoaded = true;
          }
        });
        
        $('#kanban-tab').on('click', function() {
          if (!window.kanbanLoaded) {
            loadKanban();
            window.kanbanLoaded = true;
          }
        });
        
        // Botões de atualização
        $('#refreshUsuarios').on('click', loadUsuarios);
        $('#refreshConteudos').on('click', loadConteudos);
        $('#refreshDashboards').on('click', loadDashboards);
        $('#refreshKanban').on('click', loadKanban);
        
        // Eventos para ver detalhes de usuários
        $(document).on('click', '.viewUserDetails', function() {
          const index = parseInt($(this).data('index'));
          console.log(`Clique em Ver Detalhes do usuário índice: ${index}`);
          
          if (!window.usuariosData || !window.usuariosData.usuarios) {
            console.error('Dados de usuários não disponíveis', { windowData: !!window.usuariosData });
            alert('Erro: dados de usuários não estão disponíveis. Tente atualizar a página.');
            return;
          }
          
          const usuario = window.usuariosData.usuarios[index];
          if (!usuario) {
            console.error('Usuário não encontrado no índice', { index, totalUsers: window.usuariosData.usuarios.length });
            alert('Usuário não encontrado. Tente atualizar a lista.');
            return;
          }
          
          // Formatar detalhes do usuário
          let detailsHTML = '<div class="user-details">';
          detailsHTML += '<h4>Detalhes do Usuário</h4>';
          detailsHTML += '<pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow: auto;">';
          detailsHTML += JSON.stringify(usuario, null, 2);
          detailsHTML += '</pre></div>';
          
          $('#modalTitle').text(`Usuário: ${usuario.nome || usuario.name || 'Sem nome'}`);
          $('#modalBody').html(detailsHTML);
          $('#detailsModal').modal('show');
        });
        
        // Eventos para ver detalhes de conteúdos
        $(document).on('click', '.viewConteudoDetails', function() {
          const index = parseInt($(this).data('index'));
          
          if (!window.conteudosData || !window.conteudosData.conteudos) {
            alert('Erro: dados de conteúdos não estão disponíveis. Tente atualizar a página.');
            return;
          }
          
          const conteudo = window.conteudosData.conteudos[index];
          if (!conteudo) {
            alert('Conteúdo não encontrado. Tente atualizar a lista.');
            return;
          }
          
          // Formatar detalhes do conteúdo
          let detailsHTML = '<div class="content-details">';
          detailsHTML += '<h4>Detalhes do Conteúdo</h4>';
          detailsHTML += '<pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow: auto;">';
          detailsHTML += JSON.stringify(conteudo, null, 2);
          detailsHTML += '</pre></div>';
          
          $('#modalTitle').text(`Conteúdo: ${conteudo.id || conteudo.conteudoId || 'Sem ID'}`);
          $('#modalBody').html(detailsHTML);
          $('#detailsModal').modal('show');
        });
        
        // Eventos para remoção de usuários
        $(document).on('click', '.removeUser', function() {
          const id = $(this).data('id');
          const nome = $(this).data('nome');
          const index = $(this).data('index');
          
          if (!id) {
            alert('Erro: ID do usuário não disponível. Não é possível remover.');
            // Log detalhado para ajudar diagnóstico
            Debug.error('Tentativa de remover usuário sem ID', {
              element: this,
              dataAttributes: {
                id: $(this).data('id'),
                nome: $(this).data('nome'),
                index: $(this).data('index')
              } 
            });
            return;
          }
          
          // Obter dados completos do usuário para diagnóstico
          const usuario = window.usuariosData?.usuarios[index];
          
          console.log(`Removendo usuário: ID=${id}, Nome=${nome}`, {
            dadosCompletos: usuario || 'Dados não disponíveis'
          });
          
          if (confirm(`Tem certeza que deseja remover o usuário "${nome}"? Esta ação não pode ser desfeita.`)) {
            console.log(`Removendo usuário: ID=${id}, Nome=${nome}`);
            
            // Adicionar feedback visual para indicar que a operação está em andamento
            const $row = $(this).closest('tr');
            $row.addClass('bg-warning');
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Removendo...');
            
            $.ajax({
              url: `/api/usuarios/${id}`,
              method: 'DELETE',
              success: function(response) {
                console.log(`Usuário removido com sucesso:`, response);
                
                // Mostrar detalhes da operação no console para depuração
                if (response.keyField) {
                  console.log(`Chave usada para remoção: ${response.keyField}`);
                }
                
                // Feedback visual de sucesso
                $row.removeClass('bg-warning').addClass('bg-success');
                setTimeout(() => {
                  // Notificar o usuário
                  alert('Usuário removido com sucesso!');
                  // Recarregar lista
                  loadUsuarios();
                }, 500);
              },
              error: function(xhr, status, error) {
                console.error('Erro ao remover usuário', { xhr: xhr.status, status, error });
                
                // Remover estado de loading
                $row.removeClass('bg-warning').addClass('bg-danger');
                $('.removeUser[data-id="'+id+'"]').prop('disabled', false).html('<i class="fas fa-trash"></i> Remover');
                
                // Obter detalhes do erro
                let errorMessage = 'Erro desconhecido';
                let errorDetails = '';
                
                try {
                  if (xhr.responseJSON) {
                    errorMessage = xhr.responseJSON.error || error || 'Erro desconhecido';
                    
                    // Coletar detalhes adicionais do erro para exibição
                    if (xhr.responseJSON.id) {
                      errorDetails += `\nID do usuário: ${xhr.responseJSON.id}`;
                    }
                    if (xhr.responseJSON.code) {
                      errorDetails += `\nCódigo do erro: ${xhr.responseJSON.code}`;
                    }
                    if (xhr.responseJSON.message) {
                      errorDetails += `\nMensagem: ${xhr.responseJSON.message}`;
                    }
                    if (xhr.responseJSON.availableFields) {
                      errorDetails += `\nCampos disponíveis: ${xhr.responseJSON.availableFields}`;
                    }
                  }
                } catch(e) {
                  console.error('Erro ao processar resposta de erro:', e);
                }
                
                // Registrar no Debug para troubleshooting
                Debug.error(`Erro ao remover usuário ${id}`, { xhr, status, error, errorDetails });
                
                // Mostrar mensagem de erro detalhada
                alert(`Erro ao remover usuário: ${errorMessage}${errorDetails}`);
              }
            });
          }
        });
      }
    });
  </script>
</body>
</html>

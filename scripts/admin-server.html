<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radar de Tendências - Admin</title>
  
  <!-- jQuery primeiro! -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- Bootstrap CSS e JS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <style>
    .card-header {
      font-weight: bold;
    }
    .status-ativo {
      color: green;
      font-weight: bold;
    }
    .status-inativo {
      color: red;
    }
    
    /* Estilos para o Kanban */
    .kanban-column {
      margin-bottom: 20px;
    }
    
    .kanban-cards {
      min-height: 300px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .kanban-card {
      margin-bottom: 10px;
      cursor: pointer;
      border-left: 4px solid #6c757d;
    }
    
    .kanban-card-novo {
      border-left-color: #17a2b8;
    }
    
    .kanban-card-onboarding {
      border-left-color: #ffc107;
    }
    
    .kanban-card-ativo {
      border-left-color: #28a745;
    }
    
    .kanban-card-inativo {
      border-left-color: #6c757d;
    }
    
    .kanban-card-dragging {
      opacity: 0.5;
    }
    
    .kanban-card-header {
      padding: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .kanban-card-body {
      padding: 8px;
      font-size: 12px;
    }
    
    .kanban-card-footer {
      padding: 5px 8px;
      background-color: #f8f9fa;
      font-size: 11px;
      color: #6c757d;
      display: flex;
      justify-content: space-between;
    }
    
    .kanban-card .dropdown-menu {
      min-width: 150px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-radar"></i> Radar de Tendências - Painel Administrativo
      </a>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Tabs para navegação -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="usuarios-tab" data-toggle="tab" href="#usuarios" role="tab">Usuários</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="conteudos-tab" data-toggle="tab" href="#conteudos" role="tab">Conteúdos Gerados</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="kanban-tab" data-toggle="tab" href="#kanban" role="tab">Kanban de Jornada</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="perfis-tab" data-toggle="tab" href="#perfis" role="tab">Perfis de Usuários</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="dashboards-tab" data-toggle="tab" href="#dashboards" role="tab">Dashboards AWS</a>
      </li>
    </ul>
    
    <!-- Conteúdo das tabs -->
    <div class="tab-content" id="adminTabsContent">
      <!-- Tab de Usuários -->
      <div class="tab-pane fade show active" id="usuarios" role="tabpanel">
        <div class="card mt-3">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Usuários Registrados</h5>
            <button class="btn btn-sm btn-light" id="refreshUsuarios">Atualizar Dados</button>
          </div>
          <div class="card-body">
            <div id="userStats" class="mb-3">
              <div class="alert alert-info">Carregando estatísticas...</div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered" id="usuariosTable">
                <thead class="thead-dark">
                  <tr>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>Status</th>
                    <th>Data Cadastro</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="usuariosTableBody">
                  <tr>
                    <td colspan="5" class="text-center">Carregando usuários...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tab de Conteúdos -->
      <div class="tab-pane fade" id="conteudos" role="tabpanel">
        <div class="card mt-3">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Conteúdos Gerados</h5>
            <button class="btn btn-sm btn-light" id="refreshConteudos">Atualizar Dados</button>
          </div>
          <div class="card-body">
            <div id="conteudosStats" class="mb-3">
              <div class="alert alert-info">Carregando estatísticas...</div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered" id="conteudosTable">
                <thead class="thead-dark">
                  <tr>
                    <th>ID</th>
                    <th>Tipo</th>
                    <th>Usuário</th>
                    <th>Data Criação</th>
                    <th>Conteúdo</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="conteudosTableBody">
                  <tr>
                    <td colspan="6" class="text-center">Carregando conteúdos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tab de Kanban -->
      <div class="tab-pane fade" id="kanban" role="tabpanel">
        <div class="card mt-3">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Kanban de Jornada do Usuário</h5>
            <button class="btn btn-sm btn-light" id="refreshKanban">
              <i class="fas fa-sync-alt"></i> Atualizar
            </button>
          </div>
          <div class="card-body">
            <!-- Filtro e legenda -->
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="Filtrar usuários..." id="kanbanFilter">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="applyFilter">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6 text-right">
                <span class="badge badge-primary">Total: <span id="kanbanTotalUsuarios">0</span></span>
              </div>
            </div>
            
            <!-- Quadro Kanban -->
            <div class="kanban-board">
              <div class="row">
                <!-- Coluna: Novo -->
                <div class="col-md-3 kanban-column">
                  <div class="card">
                    <div class="card-header bg-info text-white">
                      Novos <span class="badge badge-light" id="count-novos">0</span>
                    </div>
                    <div class="card-body kanban-cards" id="kanban-novos">
                      <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Coluna: Em Onboarding -->
                <div class="col-md-3 kanban-column">
                  <div class="card">
                    <div class="card-header bg-warning text-white">
                      Em Onboarding <span class="badge badge-light" id="count-onboarding">0</span>
                    </div>
                    <div class="card-body kanban-cards" id="kanban-onboarding">
                      <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Coluna: Em Progresso -->
                <div class="col-md-3 kanban-column">
                  <div class="card">
                    <div class="card-header bg-success text-white">
                      Em Progresso <span class="badge badge-light" id="count-em-progresso">0</span>
                    </div>
                    <div class="card-body kanban-cards" id="kanban-em-progresso">
                      <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Coluna: Concluído -->
                <div class="col-md-3 kanban-column">
                  <div class="card">
                    <div class="card-header bg-secondary text-white">
                      Concluído <span class="badge badge-light" id="count-concluido">0</span>
                    </div>
                    <div class="card-body kanban-cards" id="kanban-concluido">
                      <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tab de Perfis de Usuários -->
      <div class="tab-pane fade" id="perfis" role="tabpanel">
        <div class="card mt-3">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Análise de Perfis de Usuários</h5>
            <button class="btn btn-sm btn-light" id="refreshPerfis">
              <i class="fas fa-sync-alt"></i> Atualizar
            </button>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="alert alert-info" id="perfisInfo">
                  <i class="fas fa-info-circle"></i> Esta visualização mostra estatísticas sobre as escolhas e preferências dos usuários do sistema.
                </div>
              </div>
            </div>
            
            <!-- Primeira linha de gráficos -->
            <div class="row mb-4">
              <!-- Gráfico de interesses primários -->
              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Interesses Primários dos Usuários</h6>
                  </div>
                  <div class="card-body">
                    <canvas id="chartInteressesPrimarios" height="250"></canvas>
                  </div>
                </div>
              </div>
              
              <!-- Gráfico de frequência de mensagens -->
              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Preferência de Frequência de Mensagens</h6>
                  </div>
                  <div class="card-body">
                    <canvas id="chartFrequenciaMensagens" height="250"></canvas>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Segunda linha de gráficos -->
            <div class="row mb-4">
              <!-- Gráfico de tipos de conteúdos favoritos -->
              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Tipos de Conteúdo Preferidos</h6>
                  </div>
                  <div class="card-body">
                    <canvas id="chartTiposConteudo" height="250"></canvas>
                  </div>
                </div>
              </div>
              
              <!-- Gráfico de formato de conteúdo preferido -->
              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Formato de Conteúdo Preferido</h6>
                  </div>
                  <div class="card-body">
                    <canvas id="chartFormatoConteudo" height="250"></canvas>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Terceira linha de gráficos e estatísticas -->
            <div class="row mb-4">
              <!-- Gráfico de cargos/funções -->
              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Cargos/Funções dos Usuários</h6>
                  </div>
                  <div class="card-body">
                    <canvas id="chartCargos" height="250"></canvas>
                  </div>
                </div>
              </div>
              
              <!-- Gráfico de tamanho das empresas -->
              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Tamanho das Empresas</h6>
                  </div>
                  <div class="card-body">
                    <canvas id="chartTamanhoEmpresa" height="250"></canvas>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Quarta linha com mapa de calor de horários preferidos -->
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Horários Preferidos para Receber Conteúdo</h6>
                  </div>
                  <div class="card-body">
                    <canvas id="chartHorarioPreferido" height="200"></canvas>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Quinta linha com dados de engajamento -->
            <div class="row">
              <div class="col-md-12">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Desafios Mais Comuns Relatados</h6>
                  </div>
                  <div class="card-body">
                    <canvas id="chartDesafios" height="250"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tab de Dashboards AWS -->
      <div class="tab-pane fade" id="dashboards" role="tabpanel">
        <div class="card mt-3">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Dashboards AWS</h5>
            <button class="btn btn-sm btn-light" id="refreshDashboards">
              <i class="fas fa-sync-alt"></i> Atualizar
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-bordered" id="dashboardsTable">
                <thead class="thead-dark">
                  <tr>
                    <th>Nome</th>
                    <th>URL</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="dashboardsTableBody">
                  <tr>
                    <td colspan="3" class="text-center">Carregando dashboards...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para detalhes -->
  <div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Detalhes</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Conteúdo dinâmico aqui -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Adicione isso logo após o elemento body -->
  <div id="debug-info" style="position: fixed; bottom: 0; right: 0; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; max-width: 400px; max-height: 200px; overflow: auto; z-index: 9999; font-size: 12px; display: none;">
    <h6><i class="fas fa-bug"></i> Informações de Depuração</h6>
    <div id="debug-content"></div>
  </div>

  <!-- Verificação de jQuery - adicionado após o jQuery e antes dos outros scripts -->
  <script>
    // Verificar se jQuery está disponível
    if (typeof jQuery === 'undefined') {
      console.error('ERRO CRÍTICO: jQuery não está carregado!');
      document.body.innerHTML = '<div style="padding: 20px; background-color: #f8d7da; color: #721c24; margin: 20px;">ERRO: jQuery não foi carregado corretamente. Por favor, recarregue a página ou contate o suporte.</div>';
    } else {
      console.log('jQuery carregado corretamente! Versão:', $.fn.jquery);
    }
  </script>
  
  <!-- Outros scripts após a verificação -->
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!-- Script para funções administrativas -->
  <script src="admin-functions.js"></script>

  <!-- Scripts específicos para funcionalidades da interface -->
  <script>
    $(document).ready(function() {
      // Função para carregar usuários
      function loadUsuarios() {
        $('#userStats').html(`
          <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> Carregando estatísticas de usuários...
          </div>
        `);
        
        $('#usuariosTableBody').html(`
          <tr>
            <td colspan="5" class="text-center">
              <i class="fas fa-spinner fa-spin"></i> Carregando usuários...
            </td>
          </tr>
        `);
        
        $.ajax({
          url: '/api/usuarios',
          method: 'GET',
          success: function(response) {
            // Atualizar estatísticas
            const total = response.count || 0;
            const ativos = response.ativos || 0;
            const percentAtivos = total > 0 ? ((ativos / total) * 100).toFixed(1) : 0;
            
            $('#userStats').html(`
              <div class="row">
                <div class="col-md-4">
                  <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                      <h3>${total}</h3>
                      <p class="mb-0">Total de Usuários</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bg-success text-white">
                    <div class="card-body text-center">
                      <h3>${ativos}</h3>
                      <p class="mb-0">Usuários Ativos</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bg-info text-white">
                    <div class="card-body text-center">
                      <h3>${percentAtivos}%</h3>
                      <p class="mb-0">Taxa de Ativação</p>
                    </div>
                  </div>
                </div>
              </div>
            `);
            
            // Limpar e preencher tabela
            $('#usuariosTableBody').empty();
            
            if (response.usuarios && response.usuarios.length > 0) {
              response.usuarios.forEach(function(usuario) {
                const nome = usuario.name || 'Sem nome';
                const telefone = usuario.phoneNumber || usuario.telefone || 'Não informado';
                const status = determinarStatus(usuario);
                const dataCadastro = formatarData(usuario.createdAt || usuario.dataCadastro || new Date().toISOString());
                
                $('#usuariosTableBody').append(`
                  <tr>
                    <td>${nome}</td>
                    <td>${telefone}</td>
                    <td class="${status === 'Ativo' ? 'status-ativo' : 'status-inativo'}">${status}</td>
                    <td>${dataCadastro}</td>
                    <td>
                      <button class="btn btn-sm btn-info ver-detalhes" data-id="${usuario.userId || usuario.id}">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-danger remover-usuario" data-id="${usuario.userId || usuario.id}">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                `);
              });
              
              // Adicionar event listeners para botões
              $('.ver-detalhes').click(function() {
                const userId = $(this).data('id');
                mostrarDetalhesUsuario(userId, response.usuarios);
              });
              
              $('.remover-usuario').click(function() {
                const userId = $(this).data('id');
                confirmarRemocaoUsuario(userId);
              });
            } else {
              $('#usuariosTableBody').html(`
                <tr>
                  <td colspan="5" class="text-center">Nenhum usuário encontrado</td>
                </tr>
              `);
            }
          },
          error: function(xhr, status, error) {
            $('#userStats').html(`
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                Erro ao carregar estatísticas: ${error}
              </div>
            `);
            
            $('#usuariosTableBody').html(`
              <tr>
                <td colspan="5" class="text-center text-danger">
                  Erro ao carregar usuários: ${error}
                </td>
              </tr>
            `);
            console.error('Erro ao carregar usuários:', error);
          }
        });
      }
      
      // Função para carregar conteúdos
      function loadConteudos() {
        $('#conteudosStats').html(`
          <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> Carregando estatísticas de conteúdos...
          </div>
        `);
        
        $('#conteudosTableBody').html(`
          <tr>
            <td colspan="6" class="text-center">
              <i class="fas fa-spinner fa-spin"></i> Carregando conteúdos...
            </td>
          </tr>
        `);
        
        $.ajax({
          url: '/api/conteudos',
          method: 'GET',
          success: function(response) {
            // Atualizar estatísticas
            const total = response.count || 0;
            const categorias = response.categorias || {};
            
            let categoriasHTML = '';
            for (const [categoria, count] of Object.entries(categorias)) {
              categoriasHTML += `<span class="badge badge-primary mr-2">${categoria}: ${count}</span>`;
            }
            
            $('#conteudosStats').html(`
              <div class="row">
                <div class="col-md-4">
                  <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                      <h3>${total}</h3>
                      <p class="mb-0">Total de Conteúdos</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-8">
                  <div class="card">
                    <div class="card-body">
                      <h5>Categorias:</h5>
                      <p>${categoriasHTML || 'Nenhuma categoria encontrada'}</p>
                    </div>
                  </div>
                </div>
              </div>
            `);
            
            // Limpar e preencher tabela
            $('#conteudosTableBody').empty();
            
            if (response.conteudos && response.conteudos.length > 0) {
              response.conteudos.forEach(function(conteudo) {
                const id = conteudo.contentId || conteudo.id || 'ID não disponível';
                const tipo = conteudo.contentType || conteudo.tipo || 'Não especificado';
                const usuario = conteudo.userId || conteudo.usuarioId || 'Sistema';
                const dataCriacao = formatarData(conteudo.createdAt || conteudo.dataCriacao || new Date().toISOString());
                
                // Preparar preview do conteúdo
                let previewConteudo = '';
                if (conteudo.versions && conteudo.versions.brief) {
                  previewConteudo = conteudo.versions.brief.substring(0, 100) + '...';
                } else if (conteudo.conteudo) {
                  previewConteudo = conteudo.conteudo.substring(0, 100) + '...';
                } else {
                  previewConteudo = 'Conteúdo não disponível';
                }
                
                $('#conteudosTableBody').append(`
                  <tr>
                    <td>${id}</td>
                    <td>${tipo}</td>
                    <td>${usuario}</td>
                    <td>${dataCriacao}</td>
                    <td>${previewConteudo}</td>
                    <td>
                      <button class="btn btn-sm btn-info ver-conteudo" data-id="${id}">
                        <i class="fas fa-eye"></i>
                      </button>
                    </td>
                  </tr>
                `);
              });
              
              // Adicionar event listeners para botões
              $('.ver-conteudo').click(function() {
                const contentId = $(this).data('id');
                mostrarDetalhesConteudo(contentId, response.conteudos);
              });
            } else {
              $('#conteudosTableBody').html(`
                <tr>
                  <td colspan="6" class="text-center">Nenhum conteúdo encontrado</td>
                </tr>
              `);
            }
          },
          error: function(xhr, status, error) {
            $('#conteudosStats').html(`
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                Erro ao carregar estatísticas: ${error}
              </div>
            `);
            
            $('#conteudosTableBody').html(`
              <tr>
                <td colspan="6" class="text-center text-danger">
                  Erro ao carregar conteúdos: ${error}
                </td>
              </tr>
            `);
            console.error('Erro ao carregar conteúdos:', error);
          }
        });
      }
      
      // Função para carregar dados do Kanban
      function loadKanbanData() {
        // Limpar quadros kanban e adicionar indicadores de carregamento
        ['novos', 'onboarding', 'em-progresso', 'concluido'].forEach(coluna => {
          $(`#kanban-${coluna}`).html(`
            <div class="text-center text-muted">
              <i class="fas fa-spinner fa-spin"></i> Carregando...
            </div>
          `);
          $(`#count-${coluna}`).text('0');
        });
        
        // Carregar usuários para o kanban
        $.ajax({
          url: '/api/usuarios',
          method: 'GET',
          success: function(response) {
            // Mapa para distribuir usuários nas colunas do kanban
            const kanbanMap = {
              'novos': [],
              'onboarding': [],
              'em-progresso': [],
              'concluido': []
            };
            
            // Classificar usuários por coluna
            if (response.usuarios && response.usuarios.length > 0) {
              $('#kanbanTotalUsuarios').text(response.usuarios.length);
              
              response.usuarios.forEach(usuario => {
                // Determinar a coluna com base no status e comportamento
                let coluna = 'novos';
                
                if (usuario.onboardingCompleted) {
                  coluna = 'em-progresso';
                  
                  // Se tiver alto engajamento, mover para completado
                  if (usuario.engagement && usuario.engagement.engagementScore > 70) {
                    coluna = 'concluido';
                  }
                } else if (usuario.lastActive) {
                  // Se não completou onboarding mas tem atividade, está em onboarding
                  coluna = 'onboarding';
                }
                
                // Adicionar à coluna correspondente
                kanbanMap[coluna].push(usuario);
              });
              
              // Preencher cada coluna do kanban
              for (const [coluna, usuarios] of Object.entries(kanbanMap)) {
                $(`#count-${coluna}`).text(usuarios.length);
                
                if (usuarios.length === 0) {
                  $(`#kanban-${coluna}`).html(`
                    <div class="text-center text-muted">
                      <i class="fas fa-inbox"></i> Nenhum usuário nesta coluna
                    </div>
                  `);
                  continue;
                }
                
                $(`#kanban-${coluna}`).empty();
                
                // Adicionar cartões para cada usuário
                usuarios.forEach(usuario => {
                  const nome = usuario.name || 'Usuário sem nome';
                  const telefone = usuario.phoneNumber || usuario.telefone || 'Sem telefone';
                  const dataCadastro = formatarData(usuario.createdAt || usuario.dataCadastro || new Date().toISOString());
                  
                  let statusClass = '';
                  switch (coluna) {
                    case 'novos': statusClass = 'kanban-card-novo'; break;
                    case 'onboarding': statusClass = 'kanban-card-onboarding'; break;
                    case 'em-progresso': statusClass = 'kanban-card-ativo'; break;
                    case 'concluido': statusClass = 'kanban-card-inativo'; break;
                  }
                  
                  $(`#kanban-${coluna}`).append(`
                    <div class="card kanban-card ${statusClass}" data-id="${usuario.userId || usuario.id}">
                      <div class="kanban-card-header">
                        <strong>${nome}</strong>
                        <div class="dropdown">
                          <button class="btn btn-sm py-0 px-1" type="button" data-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                          </button>
                          <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item ver-usuario" href="#" data-id="${usuario.userId || usuario.id}">
                              <i class="fas fa-eye"></i> Ver detalhes
                            </a>
                            <a class="dropdown-item mover-usuario" href="#" data-coluna="novos">
                              <i class="fas fa-arrow-right"></i> Mover para Novos
                            </a>
                            <a class="dropdown-item mover-usuario" href="#" data-coluna="onboarding">
                              <i class="fas fa-arrow-right"></i> Mover para Onboarding
                            </a>
                            <a class="dropdown-item mover-usuario" href="#" data-coluna="em-progresso">
                              <i class="fas fa-arrow-right"></i> Mover para Em Progresso
                            </a>
                            <a class="dropdown-item mover-usuario" href="#" data-coluna="concluido">
                              <i class="fas fa-arrow-right"></i> Mover para Concluído
                            </a>
                          </div>
                        </div>
                      </div>
                      <div class="kanban-card-body">
                        <div><i class="fas fa-phone-alt"></i> ${telefone}</div>
                        <div class="mt-1">
                          ${usuario.profile && usuario.profile.role ? 
                            `<span class="badge badge-secondary">${usuario.profile.role}</span>` : ''}
                          ${usuario.profile && usuario.profile.industry ? 
                            `<span class="badge badge-info">${usuario.profile.industry}</span>` : ''}
                        </div>
                      </div>
                      <div class="kanban-card-footer">
                        <span><i class="far fa-calendar-alt"></i> ${dataCadastro}</span>
                        <span>
                          ${usuario.engagement && usuario.engagement.engagementScore ? 
                            `<i class="fas fa-chart-line"></i> ${usuario.engagement.engagementScore}` : 
                            '<i class="fas fa-circle"></i> Novo'}
                        </span>
                      </div>
                    </div>
                  `);
                });
                
                // Adicionar listeners para os botões de ação
                $(`#kanban-${coluna} .ver-usuario`).click(function(e) {
                  e.preventDefault();
                  const id = $(this).data('id');
                  mostrarDetalhesUsuario(id, response.usuarios || []);
                });
                
                $(`#kanban-${coluna} .mover-usuario`).click(function(e) {
                  e.preventDefault();
                  const id = $(this).closest('.kanban-card').data('id');
                  const colunaDestino = $(this).data('coluna');
                  moverUsuarioKanban(id, coluna, colunaDestino);
                });
              }
            } else {
              ['novos', 'onboarding', 'em-progresso', 'concluido'].forEach(coluna => {
                $(`#kanban-${coluna}`).html(`
                  <div class="text-center text-muted">
                    <i class="fas fa-exclamation-circle"></i> Sem dados disponíveis
                  </div>
                `);
              });
              
              $('#kanbanTotalUsuarios').text('0');
            }
          },
          error: function(xhr, status, error) {
            ['novos', 'onboarding', 'em-progresso', 'concluido'].forEach(coluna => {
              $(`#kanban-${coluna}`).html(`
                <div class="text-center text-danger">
                  <i class="fas fa-exclamation-triangle"></i>
                  Erro ao carregar dados: ${error}
                </div>
              `);
            });
            
            console.error('Erro ao carregar dados do kanban:', error);
          }
        });
      }
      
      // Funções utilitárias
      function determinarStatus(usuario) {
        if (usuario.status === 'ativo' || 
            usuario.ativo === true || 
            usuario.situacao === 'ativo' || 
            usuario.active === true ||
            (typeof usuario.status === 'number' && usuario.status === 1)) {
          return 'Ativo';
        } else {
          return 'Inativo';
        }
      }
      
      function formatarData(dataStr) {
        try {
          const data = new Date(dataStr);
          return data.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch (e) {
          return 'Data inválida';
        }
      }
      
      function mostrarDetalhesUsuario(userId, usuarios) {
        // Verificar se usuarios é um array ou um objeto único
        let usuario;
        
        if (Array.isArray(usuarios)) {
          // Se for um array, encontrar o usuário pelo ID
          usuario = usuarios.find(u => (u.userId || u.id) === userId);
        } else if (usuarios && typeof usuarios === 'object') {
          // Se for um objeto único, verificar se o ID corresponde
          if ((usuarios.userId || usuarios.id) === userId) {
            usuario = usuarios;
          }
        }
        
        if (!usuario) {
          // Se o usuário não for encontrado, buscar do servidor
          $.ajax({
            url: `/api/usuarios`,
            method: 'GET',
            success: function(response) {
              if (response && response.usuarios && Array.isArray(response.usuarios)) {
                const usuarioEncontrado = response.usuarios.find(u => (u.userId || u.id) === userId);
                if (usuarioEncontrado) {
                  exibirDetalhesUsuario(usuarioEncontrado);
                } else {
                  mostrarNotificacao('Erro', 'Usuário não encontrado no servidor', 'danger');
                }
              } else {
                mostrarNotificacao('Erro', 'Não foi possível obter detalhes do usuário', 'danger');
              }
            },
            error: function() {
              mostrarNotificacao('Erro', 'Falha ao buscar detalhes do usuário', 'danger');
            }
          });
          return;
        }
        
        exibirDetalhesUsuario(usuario);
      }
      
      // Função auxiliar para exibir os detalhes do usuário na modal
      function exibirDetalhesUsuario(usuario) {
        let detalhesHTML = `
          <div class="row">
            <div class="col-md-6">
              <h5>Informações Básicas</h5>
              <table class="table table-sm">
                <tr>
                  <th>ID:</th>
                  <td>${usuario.userId || usuario.id || 'N/A'}</td>
                </tr>
                <tr>
                  <th>Nome:</th>
                  <td>${usuario.name || 'Não informado'}</td>
                </tr>
                <tr>
                  <th>Telefone:</th>
                  <td>${usuario.phoneNumber || usuario.telefone || 'Não informado'}</td>
                </tr>
                <tr>
                  <th>Email:</th>
                  <td>${usuario.email || 'Não informado'}</td>
                </tr>
                <tr>
                  <th>Status:</th>
                  <td>${usuario.status || 'Não definido'}</td>
                </tr>
                <tr>
                  <th>Criado em:</th>
                  <td>${formatarData(usuario.createdAt || usuario.dataCriacao || 'N/A')}</td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <h5>Preferências</h5>
              <table class="table table-sm">
                <tr>
                  <th>Frequência:</th>
                  <td>${usuario.preferences?.frequency || 'Não definida'}</td>
                </tr>
                <tr>
                  <th>Interesse Principal:</th>
                  <td>${usuario.preferences?.interests ? usuario.preferences.interests.map(i => i.category).join(', ') : 'Não definido'}</td>
                </tr>
                <tr>
                  <th>Formato Preferido:</th>
                  <td>${usuario.preferences?.preferredContentFormat || 'Não definido'}</td>
                </tr>
              </table>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <h5>Informações Adicionais</h5>
              <pre class="bg-light p-2" style="max-height: 200px; overflow-y: auto;">${JSON.stringify(usuario, null, 2)}</pre>
            </div>
          </div>
        `;
        
        // Injetar o HTML no modal existente e exibir
        $('#modalTitle').text(`Detalhes do Usuário: ${usuario.name || 'Sem Nome'}`);
        $('#modalBody').html(detalhesHTML);
        $('#detailsModal').modal('show');
      }
      
      function mostrarDetalhesConteudo(contentId, conteudos) {
        const conteudo = conteudos.find(c => (c.contentId || c.id) === contentId);
        
        if (!conteudo) {
          alert('Conteúdo não encontrado!');
          return;
        }
        
        let detalhesHTML = `
          <div class="row">
            <div class="col-md-5">
              <h5>Informações Básicas</h5>
              <table class="table table-sm">
                <tr>
                  <th>ID:</th>
                  <td>${conteudo.contentId || conteudo.id || 'N/A'}</td>
                </tr>
                <tr>
                  <th>Tipo:</th>
                  <td>${conteudo.contentType || conteudo.tipo || 'Não especificado'}</td>
                </tr>
                <tr>
                  <th>Usuário:</th>
                  <td>${conteudo.userId || conteudo.usuarioId || 'Sistema'}</td>
                </tr>
                <tr>
                  <th>Data Criação:</th>
                  <td>${formatarData(conteudo.createdAt || conteudo.dataCriacao || '')}</td>
                </tr>
                <tr>
                  <th>Categorias:</th>
                  <td>${
                    conteudo.categories ? 
                    conteudo.categories.map(cat => `<span class="badge badge-info mr-1">${cat}</span>`).join('') :
                    (conteudo.categoria ? `<span class="badge badge-info">${conteudo.categoria}</span>` : 'Não especificado')
                  }</td>
                </tr>
              </table>
            </div>
            <div class="col-md-7">
              <h5>Conteúdo</h5>
              <div class="card">
                <div class="card-body">
                  ${conteudo.versions ? `
                    <ul class="nav nav-tabs" id="contentTabs" role="tablist">
                      <li class="nav-item">
                        <a class="nav-link active" id="brief-tab" data-toggle="tab" href="#brief" role="tab">Resumido</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" id="detailed-tab" data-toggle="tab" href="#detailed" role="tab">Detalhado</a>
                      </li>
                    </ul>
                    <div class="tab-content mt-2" id="contentTabsContent">
                      <div class="tab-pane fade show active" id="brief" role="tabpanel">
                        <p>${conteudo.versions.brief || 'Não disponível'}</p>
                      </div>
                      <div class="tab-pane fade" id="detailed" role="tabpanel">
                        <p>${conteudo.versions.detailed || 'Não disponível'}</p>
                      </div>
                    </div>
                  ` : (conteudo.conteudo ? `<p>${conteudo.conteudo}</p>` : '<p>Conteúdo não disponível</p>')}
                </div>
              </div>
              
              ${conteudo.metrics ? `
                <div class="card mt-3">
                  <div class="card-header">Métricas</div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-4 text-center">
                        <h4>${conteudo.metrics.impressions || 0}</h4>
                        <small>Impressões</small>
                      </div>
                      <div class="col-md-4 text-center">
                        <h4>${conteudo.metrics.clicks || 0}</h4>
                        <small>Cliques</small>
                      </div>
                      <div class="col-md-4 text-center">
                        <h4>${conteudo.metrics.feedbackScore || 0}</h4>
                        <small>Avaliação</small>
                      </div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
        
        $('#modalTitle').text(`Detalhes do Conteúdo: ${conteudo.title || conteudo.contentId || ''}`);
        $('#modalBody').html(detalhesHTML);
        $('#detailsModal').modal('show');
      }
      
      function confirmarRemocaoUsuario(userId) {
        if (confirm(`Tem certeza que deseja remover o usuário ${userId}?`)) {
          // Aqui você pode implementar a chamada à API para remover o usuário
          alert(`Solicitação para remover o usuário ${userId} enviada.`);
        }
      }

      // Função para carregar os dashboards
      function loadDashboards() {
        $('#dashboardsList').html(`
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Carregando...</span>
            </div>
            <p>Carregando dashboards...</p>
          </div>
        `);
        
        $.ajax({
          url: '/api/dashboards',
          method: 'GET',
          success: function(data) {
            $('#dashboardsList').empty();
            
            if (data.dashboards.length === 0) {
              $('#dashboardsList').html('<div class="alert alert-warning">Nenhum dashboard encontrado no CloudWatch</div>');
              return;
            }
            
            data.dashboards.forEach(function(dashboard) {
              $('#dashboardsList').append(`
                <a href="${dashboard.url}" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-chart-line mr-2"></i>
                    ${dashboard.name}
                  </div>
                  <span class="badge badge-primary badge-pill">Abrir <i class="fas fa-external-link-alt ml-1"></i></span>
                </a>
              `);
            });
            
            // Adicionar link para o dashboard principal
            const region = data.region || 'us-east-1';
            $('#dashboardsList').append(`
              <a href="https://console.aws.amazon.com/cloudwatch/home?region=${region}#dashboards:name=RadarTendenciasDashboard" 
                 target="_blank" class="list-group-item list-group-item-action list-group-item-primary d-flex justify-content-between align-items-center">
                <div>
                  <i class="fas fa-star mr-2"></i>
                  RadarTendenciasDashboard (Principal)
                </div>
                <span class="badge badge-primary badge-pill">Abrir <i class="fas fa-external-link-alt ml-1"></i></span>
              </a>
            `);
          },
          error: function(err) {
            console.error('Erro ao carregar dashboards:', err);
            $('#dashboardsList').html(`<div class="alert alert-danger">
              Erro ao carregar dashboards: ${err.responseJSON?.error || err.statusText || 'Erro desconhecido'}
            </div>`);
          }
        });
      }
      
      // Função para carregar dados da aba de perfis de usuários
      function loadPerfisUsuarios() {
        $('#perfisInfo').html(`
          <i class="fas fa-spinner fa-spin"></i> Carregando dados de perfis dos usuários...
        `);
        
        // Fazer a solicitação para obter os dados dos usuários
        $.ajax({
          url: '/api/usuarios/perfis',
          method: 'GET',
          success: function(response) {
            $('#perfisInfo').html(`
              <i class="fas fa-info-circle"></i> Análise baseada em ${response.count} usuários.
              Última atualização: ${new Date().toLocaleString('pt-BR')}
            `);
            
            // Processa e exibe os dados como gráficos
            processarDadosPerfil(response.estatisticas);
          },
          error: function(xhr, status, error) {
            $('#perfisInfo').html(`
              <i class="fas fa-exclamation-triangle text-danger"></i> 
              Erro ao carregar dados de perfis: ${error}
            `);
            console.error('Erro ao carregar perfis:', error);
          }
        });
      }
      
      // Função para processar os dados e criar os gráficos
      function processarDadosPerfil(dados) {
        // Limpar todos os gráficos existentes
        function limparTodosGraficos() {
          console.log('Limpando todos os gráficos existentes...');
          
          // Destruir instâncias anteriores dos gráficos
          const graficos = {
            'chartInteressesPrimarios': 'chartInteresses',
            'chartFrequenciaMensagens': 'chartFreq',
            'chartTiposConteudo': 'chartTipos',
            'chartFormatoConteudo': 'chartFormatos',
            'chartCargos': 'chartCargos', 
            'chartTamanhoEmpresa': 'chartTamanho',
            'chartDesafios': 'chartDesafios',
            'chartHorarioPreferido': 'chartHorarios'
          };
          
          for (const [canvasId, chartVarName] of Object.entries(graficos)) {
            try {
              if (window[chartVarName] && typeof window[chartVarName].destroy === 'function') {
                window[chartVarName].destroy();
                console.log(`Destruído gráfico: ${chartVarName}`);
              }
            } catch (err) {
              console.error(`Erro ao destruir gráfico ${chartVarName}:`, err);
            }
            
            // Limpar o canvas
            const canvas = document.getElementById(canvasId);
            if (canvas) {
              try {
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                // Redefinir o canvas para forçar um redesenho
                const w = canvas.width;
                canvas.width = 1;
                canvas.width = w;
              } catch (err) {
                console.error(`Erro ao limpar canvas ${canvasId}:`, err);
              }
            }
          }
          
          // Redefinir as variáveis globais
          window.chartInteresses = null;
          window.chartFreq = null;
          window.chartTipos = null;
          window.chartFormatos = null;
          window.chartCargos = null;
          window.chartTamanho = null;
          window.chartDesafios = null;
          window.chartHorarios = null;
        }
        
        // Limpar todos os gráficos existentes antes de começar
        limparTodosGraficos();
        
        // Inicializar variáveis globais dos gráficos
        if (!window.chartInteresses) window.chartInteresses = null;
        if (!window.chartFreq) window.chartFreq = null;
        if (!window.chartTipos) window.chartTipos = null;
        if (!window.chartFormatos) window.chartFormatos = null;
        if (!window.chartCargos) window.chartCargos = null;
        if (!window.chartTamanho) window.chartTamanho = null;
        if (!window.chartDesafios) window.chartDesafios = null;
        if (!window.chartHorarios) window.chartHorarios = null;
        
        // Garantir que temos dados para trabalhar
        if (!dados || dados.erro) {
          $('#perfisInfo').html(`
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i> 
              Nenhum dado de usuário disponível para análise: ${dados?.erro || "Erro desconhecido"}
            </div>
          `);
          return;
        }
        
        // Traduzir os nomes de interesses para português
        const traducaoInteresses = {
          'social_media_marketing': 'Marketing em Redes Sociais',
          'content_marketing': 'Marketing de Conteúdo',
          'seo': 'SEO',
          'email_marketing': 'E-mail Marketing',
          'inbound_marketing': 'Inbound Marketing',
          'performance_marketing': 'Marketing de Performance',
          'affiliate_marketing': 'Marketing de Afiliados',
          'digital_marketing': 'Marketing Digital',
          'content_strategy': 'Estratégia de Conteúdo'
        };
        
        // Traduzir frequências para português
        const traducaoFreq = {
          'high': 'Alta',
          'medium': 'Média',
          'low': 'Baixa',
          'daily': 'Diária',
          'weekly': 'Semanal',
          'monthly': 'Mensal'
        };
        
        // Traduzir tipos de conteúdo para português
        const traducaoTipos = {
          'news': 'Notícias',
          'tools': 'Ferramentas',
          'cases': 'Casos de Uso',
          'tips': 'Dicas',
          'tutorials': 'Tutoriais',
          'insights': 'Insights',
          'trends': 'Tendências',
          'analysis': 'Análises',
          'guides': 'Guias'
        };
        
        // Traduzir formatos para português
        const traducaoFormatos = {
          'brief': 'Resumido',
          'detailed': 'Detalhado',
          'visual': 'Visual',
          'interactive': 'Interativo',
          'video': 'Vídeo',
          'audio': 'Áudio'
        };
        
        // Traduzir cargos para português
        const traducaoCargos = {
          'marketing_manager': 'Gerente de Marketing',
          'content_creator': 'Criador de Conteúdo',
          'social_media': 'Social Media',
          'seo_specialist': 'Especialista SEO',
          'digital_marketing': 'Marketing Digital',
          'product_manager': 'Gerente de Produto',
          'entrepreneur': 'Empreendedor',
          'other': 'Outros',
          'ceo': 'CEO',
          'cmo': 'CMO',
          'analyst': 'Analista',
          'consultant': 'Consultor'
        };
        
        // Traduzir tamanhos de empresa para português
        const traducaoTamanhos = {
          'small': 'Pequena',
          'medium': 'Média',
          'large': 'Grande',
          'enterprise': 'Empresarial',
          'startup': 'Startup',
          'solo': 'Autônomo'
        };
        
        // Traduzir desafios para português
        const traducaoDesafios = {
          'content_creation': 'Criação de Conteúdo',
          'audience_growth': 'Crescimento de Audiência',
          'engagement': 'Engajamento',
          'roi': 'Retorno sobre Investimento',
          'competition': 'Concorrência',
          'resources': 'Recursos',
          'technology': 'Tecnologia',
          'time_management': 'Gestão de Tempo',
          'strategy': 'Estratégia',
          'measurement': 'Mensuração de Resultados'
        };

        try {
          // 1. Gráfico de Interesses Primários
          if (dados.interessesPrimarios && Object.keys(dados.interessesPrimarios).length > 0) {
            const ctxInteresses = document.getElementById('chartInteressesPrimarios');
            if (ctxInteresses) {
              try {
                const context = ctxInteresses.getContext('2d');
                window.chartInteresses = new Chart(context, {
                  type: 'doughnut',
                  data: {
                    labels: Object.keys(dados.interessesPrimarios).map(key => traducaoInteresses[key] || key),
                    datasets: [{
                      data: Object.values(dados.interessesPrimarios),
                      backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'
                      ]
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      legend: {
                        position: 'right',
                      },
                      title: {
                        display: true,
                        text: 'Distribuição de Interesses Primários'
                      }
                    }
                  }
                });
              } catch (err) {
                console.error('Erro ao criar gráfico de interesses:', err);
                ctxInteresses.parentElement.innerHTML = 
                  '<div class="text-center text-danger">Erro ao criar gráfico: ' + err.message + '</div>';
              }
            }
          } else {
            const element = document.getElementById('chartInteressesPrimarios');
            if (element && element.parentElement) {
              element.parentElement.innerHTML = 
                '<div class="text-center text-muted">Sem dados de interesses disponíveis</div>';
            }
          }
          
          // 2. Gráfico de Frequência de Mensagens
          if (dados.freqMensagens && Object.keys(dados.freqMensagens).length > 0) {
            const ctxFreq = document.getElementById('chartFrequenciaMensagens');
            if (ctxFreq) {
              try {
                const context = ctxFreq.getContext('2d');
                window.chartFreq = new Chart(context, {
                  type: 'pie',
                  data: {
                    labels: Object.keys(dados.freqMensagens).map(key => traducaoFreq[key] || key),
                    datasets: [{
                      data: Object.values(dados.freqMensagens),
                      backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      legend: {
                        position: 'right',
                      },
                      title: {
                        display: true,
                        text: 'Preferência de Frequência de Mensagens'
                      }
                    }
                  }
                });
              } catch (err) {
                console.error('Erro ao criar gráfico de frequência:', err);
                ctxFreq.parentElement.innerHTML = 
                  '<div class="text-center text-danger">Erro ao criar gráfico: ' + err.message + '</div>';
              }
            }
          } else {
            const element = document.getElementById('chartFrequenciaMensagens');
            if (element && element.parentElement) {
              element.parentElement.innerHTML = 
                '<div class="text-center text-muted">Sem dados de frequência disponíveis</div>';
            }
          }
          
          // 3. Gráfico de Tipos de Conteúdo Preferidos
          if (dados.tiposConteudo && Object.keys(dados.tiposConteudo).length > 0) {
            const ctxTipos = document.getElementById('chartTiposConteudo');
            if (ctxTipos) {
              try {
                const context = ctxTipos.getContext('2d');
                window.chartTipos = new Chart(context, {
                  type: 'bar',
                  data: {
                    labels: Object.keys(dados.tiposConteudo).map(key => traducaoTipos[key] || key),
                    datasets: [{
                      label: 'Usuários',
                      data: Object.values(dados.tiposConteudo),
                      backgroundColor: '#36A2EB',
                      borderWidth: 1
                    }]
                  },
                  options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                      title: {
                        display: true,
                        text: 'Tipos de Conteúdo Mais Solicitados'
                      },
                      legend: {
                        display: false
                      }
                    }
                  }
                });
              } catch (err) {
                console.error('Erro ao criar gráfico de tipos de conteúdo:', err);
                ctxTipos.parentElement.innerHTML = 
                  '<div class="text-center text-danger">Erro ao criar gráfico: ' + err.message + '</div>';
              }
            }
          } else {
            const element = document.getElementById('chartTiposConteudo');
            if (element && element.parentElement) {
              element.parentElement.innerHTML = 
                '<div class="text-center text-muted">Sem dados de tipos de conteúdo disponíveis</div>';
            }
          }
          
          // 4. Gráfico de Formato de Conteúdo Preferido
          if (dados.formatosConteudo && Object.keys(dados.formatosConteudo).length > 0) {
            const ctxFormatos = document.getElementById('chartFormatoConteudo');
            if (ctxFormatos) {
              try {
                const context = ctxFormatos.getContext('2d');
                window.chartFormatos = new Chart(context, {
                  type: 'pie',
                  data: {
                    labels: Object.keys(dados.formatosConteudo).map(key => traducaoFormatos[key] || key),
                    datasets: [{
                      data: Object.values(dados.formatosConteudo),
                      backgroundColor: ['#FFCE56', '#4BC0C0', '#9966FF']
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      legend: {
                        position: 'right',
                      },
                      title: {
                        display: true,
                        text: 'Formato de Conteúdo Preferido'
                      }
                    }
                  }
                });
              } catch (err) {
                console.error('Erro ao criar gráfico de formatos:', err);
                ctxFormatos.parentElement.innerHTML = 
                  '<div class="text-center text-danger">Erro ao criar gráfico: ' + err.message + '</div>';
              }
            }
          } else {
            const element = document.getElementById('chartFormatoConteudo');
            if (element && element.parentElement) {
              element.parentElement.innerHTML = 
                '<div class="text-center text-muted">Sem dados de formatos disponíveis</div>';
            }
          }
          
          // 5. Gráfico de Cargos
          if (dados.cargos && Object.keys(dados.cargos).length > 0) {
            const ctxCargos = document.getElementById('chartCargos');
            if (ctxCargos) {
              try {
                const context = ctxCargos.getContext('2d');
                window.chartCargos = new Chart(context, {
                  type: 'pie',
                  data: {
                    labels: Object.keys(dados.cargos).map(key => traducaoCargos[key] || key),
                    datasets: [{
                      data: Object.values(dados.cargos),
                      backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                        '#9966FF', '#FF9F40', '#C9CBCF', '#1B998B'
                      ]
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      legend: {
                        position: 'right',
                      },
                      title: {
                        display: true,
                        text: 'Distribuição de Cargos/Funções'
                      }
                    }
                  }
                });
              } catch (err) {
                console.error('Erro ao criar gráfico de cargos:', err);
                ctxCargos.parentElement.innerHTML = 
                  '<div class="text-center text-danger">Erro ao criar gráfico: ' + err.message + '</div>';
              }
            }
          } else {
            const element = document.getElementById('chartCargos');
            if (element && element.parentElement) {
              element.parentElement.innerHTML = 
                '<div class="text-center text-muted">Sem dados de cargos disponíveis</div>';
            }
          }
          
          // 6. Gráfico de Tamanho das Empresas
          if (dados.tamanhoEmpresas && Object.keys(dados.tamanhoEmpresas).length > 0) {
            const ctxTamanho = document.getElementById('chartTamanhoEmpresa');
            if (ctxTamanho) {
              try {
                const context = ctxTamanho.getContext('2d');
                window.chartTamanho = new Chart(context, {
                  type: 'bar',
                  data: {
                    labels: Object.keys(dados.tamanhoEmpresas).map(key => traducaoTamanhos[key] || key),
                    datasets: [{
                      label: 'Usuários',
                      data: Object.values(dados.tamanhoEmpresas),
                      backgroundColor: '#4BC0C0',
                      borderWidth: 1
                    }]
                  },
                  options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                      title: {
                        display: true,
                        text: 'Tamanho das Empresas'
                      },
                      legend: {
                        display: false
                      }
                    }
                  }
                });
              } catch (err) {
                console.error('Erro ao criar gráfico de tamanho de empresas:', err);
                ctxTamanho.parentElement.innerHTML = 
                  '<div class="text-center text-danger">Erro ao criar gráfico: ' + err.message + '</div>';
              }
            }
          } else {
            const element = document.getElementById('chartTamanhoEmpresa');
            if (element && element.parentElement) {
              element.parentElement.innerHTML = 
                '<div class="text-center text-muted">Sem dados de tamanho de empresas disponíveis</div>';
            }
          }
          
          // 7. Gráfico de Desafios Mais Comuns
          if (dados.desafios && Object.keys(dados.desafios).length > 0) {
            const ctxDesafios = document.getElementById('chartDesafios');
            if (ctxDesafios) {
              try {
                const context = ctxDesafios.getContext('2d');
                window.chartDesafios = new Chart(context, {
                  type: 'bar',
                  data: {
                    labels: Object.keys(dados.desafios).map(key => traducaoDesafios[key] || key),
                    datasets: [{
                      label: 'Usuários',
                      data: Object.values(dados.desafios),
                      backgroundColor: '#9966FF',
                      borderWidth: 1
                    }]
                  },
                  options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                      title: {
                        display: true,
                        text: 'Desafios Mais Comuns Relatados'
                      },
                      legend: {
                        display: false
                      }
                    }
                  }
                });
              } catch (err) {
                console.error('Erro ao criar gráfico de desafios:', err);
                ctxDesafios.parentElement.innerHTML = 
                  '<div class="text-center text-danger">Erro ao criar gráfico: ' + err.message + '</div>';
              }
            }
          } else {
            const element = document.getElementById('chartDesafios');
            if (element && element.parentElement) {
              element.parentElement.innerHTML = 
                '<div class="text-center text-muted">Sem dados de desafios disponíveis</div>';
            }
          }
          
          // 8. Gráfico de Horários Preferidos
          if (dados.horariosPref && Array.isArray(dados.horariosPref) && dados.horariosPref.some(valor => valor > 0)) {
            const ctxHorarios = document.getElementById('chartHorarioPreferido');
            if (ctxHorarios) {
              try {
                const context = ctxHorarios.getContext('2d');
                
                // Criar rótulos para as horas
                const labelsHoras = [];
                for (let i = 0; i < 24; i++) {
                  labelsHoras.push(`${i < 10 ? '0' + i : i}:00`);
                }
                
                window.chartHorarios = new Chart(context, {
                  type: 'bar',
                  data: {
                    labels: labelsHoras,
                    datasets: [{
                      label: 'Preferência',
                      data: dados.horariosPref,
                      backgroundColor: '#FF9F40',
                      borderWidth: 1
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      title: {
                        display: true,
                        text: 'Horários Preferidos para Comunicação'
                      },
                      legend: {
                        display: false
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        title: {
                          display: true,
                          text: 'Número de Usuários'
                        }
                      }
                    }
                  }
                });
              } catch (err) {
                console.error('Erro ao criar gráfico de horários preferidos:', err);
                ctxHorarios.parentElement.innerHTML = 
                  '<div class="text-center text-danger">Erro ao criar gráfico: ' + err.message + '</div>';
              }
            }
          } else {
            const element = document.getElementById('chartHorarioPreferido');
            if (element && element.parentElement) {
              element.parentElement.innerHTML = 
                '<div class="text-center text-muted">Sem dados de horários preferidos disponíveis</div>';
            }
          }
        } catch (error) {
          console.error('Erro ao processar dados dos gráficos:', error);
          $('#perfisInfo').html(`
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i> 
              Erro ao processar dados dos gráficos: ${error.message}
            </div>
          `);
        }
      }
      
      // Função para mover usuário entre colunas do Kanban
      function moverUsuarioKanban(userId, colunaOrigem, colunaDestino) {
        if (!userId || !colunaOrigem || !colunaDestino) {
          console.error('Parâmetros inválidos para mover usuário');
          mostrarNotificacao('Erro', 'Parâmetros inválidos para mover usuário', 'danger');
          return;
        }
        
        // Se estiver tentando mover para a mesma coluna, não faz nada
        if (colunaOrigem === colunaDestino) {
          console.log(`Usuário ${userId} já está na coluna ${colunaDestino}`);
          mostrarNotificacao('Informação', `Usuário já está na coluna ${colunaDestino}`, 'info');
          return;
        }
        
        // Status correspondente a cada coluna
        const statusMap = {
            'novos': 'novo',
            'onboarding': 'onboarding',
            'em-progresso': 'ativo',
            'concluido': 'concluido'
        };
        
        // Atualizar visual primeiro para feedback imediato
        const cardElement = $(`#kanban-${colunaOrigem} .kanban-card[data-id="${userId}"]`);
        if (cardElement.length === 0) {
          console.error(`Card do usuário ${userId} não encontrado na coluna ${colunaOrigem}`);
          mostrarNotificacao('Erro', `Card do usuário não encontrado`, 'danger');
          return;
        }
        
        // Indicador de carregamento no card
        const originalContent = cardElement.html();
        cardElement.html(`
          <div class="p-2 text-center">
            <i class="fas fa-spinner fa-spin"></i> Movendo...
          </div>
        `);
        
        // Mover visualmente primeiro para feedback mais rápido
        const countOrigem = parseInt($(`#count-${colunaOrigem}`).text()) - 1;
        const countDestino = parseInt($(`#count-${colunaDestino}`).text()) + 1;
        $(`#count-${colunaOrigem}`).text(countOrigem >= 0 ? countOrigem : 0);
        $(`#count-${colunaDestino}`).text(countDestino);
        
        // Enviar requisição para atualizar o status do usuário
        $.ajax({
          url: `/api/usuarios/${userId}/status`,
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ 
            status: statusMap[colunaDestino],
            previousStatus: statusMap[colunaOrigem]
          }),
          success: function(response) {
            console.log(`Resposta do servidor:`, response);
            
            // Verificar se a operação foi bem-sucedida
            if (response.success) {
              console.log(`Usuário ${userId} movido com sucesso para ${colunaDestino}`);
              
              // Mover o card para a nova coluna
              cardElement.fadeOut(300, function() {
                // Restaurar conteúdo original do card
                cardElement.html(originalContent);
                
                // Remover classes específicas da coluna original
                cardElement.removeClass(function(index, className) {
                  return (className.match(/(^|\s)kanban-card-\S+/g) || []).join(' ');
                });
                
                // Adicionar a classe específica da coluna de destino
                let statusClass = '';
                switch (colunaDestino) {
                  case 'novos': statusClass = 'kanban-card-novo'; break;
                  case 'onboarding': statusClass = 'kanban-card-onboarding'; break;
                  case 'em-progresso': statusClass = 'kanban-card-ativo'; break;
                  case 'concluido': statusClass = 'kanban-card-inativo'; break;
                }
                cardElement.addClass(statusClass);
                
                // Anexar à nova coluna
                cardElement.appendTo(`#kanban-${colunaDestino}`).fadeIn(300);
                
                // Reajustar todos os event listeners para o card na nova posição
                cardElement.find('.ver-usuario').click(function(e) {
                  e.preventDefault();
                  mostrarDetalhesUsuario(userId, response.user || {});
                });
                
                cardElement.find('.mover-usuario').click(function(e) {
                  e.preventDefault();
                  const destino = $(this).data('coluna');
                  moverUsuarioKanban(userId, colunaDestino, destino);
                });
                
                // Mostrar mensagem de sucesso
                mostrarNotificacao('Sucesso!', `Usuário movido para ${colunaDestino}`, 'success');
              });
            } else {
              // A resposta não indica sucesso
              console.error('Erro retornado pelo servidor:', response);
              
              // Restaurar contadores
              const countOrigemRestaurado = parseInt($(`#count-${colunaOrigem}`).text()) + 1;
              const countDestinoRestaurado = parseInt($(`#count-${colunaDestino}`).text()) - 1;
              $(`#count-${colunaOrigem}`).text(countOrigemRestaurado);
              $(`#count-${colunaDestino}`).text(countDestinoRestaurado >= 0 ? countDestinoRestaurado : 0);
              
              // Restaurar conteúdo original do card
              cardElement.html(originalContent);
              
              // Mostrar mensagem de erro
              const mensagemErro = response.error || 'Erro desconhecido';
              mostrarNotificacao('Erro!', `Não foi possível mover o usuário: ${mensagemErro}`, 'danger');
            }
          },
          error: function(xhr, status, error) {
            console.error(`Erro ao mover usuário ${userId}:`, error);
            console.log('Resposta do servidor:', xhr.responseText);
            
            // Restaurar contadores
            const countOrigemRestaurado = parseInt($(`#count-${colunaOrigem}`).text()) + 1;
            const countDestinoRestaurado = parseInt($(`#count-${colunaDestino}`).text()) - 1;
            $(`#count-${colunaOrigem}`).text(countOrigemRestaurado);
            $(`#count-${colunaDestino}`).text(countDestinoRestaurado >= 0 ? countDestinoRestaurado : 0);
            
            // Restaurar conteúdo original do card
            cardElement.html(originalContent);
            
            try {
              // Tentar analisar a resposta detalhada do servidor
              const resposta = JSON.parse(xhr.responseText);
              let mensagemErro = resposta.error || 'Erro desconhecido';
              
              // Fornecer mensagens mais amigáveis para erros comuns
              if (resposta.code === 'ValidationException') {
                mensagemErro = 'Erro de validação no banco de dados. Tente novamente em alguns instantes.';
                console.error('Detalhes do erro de validação:', resposta.details || resposta);
              } else if (resposta.code === 'ResourceNotFoundException') {
                mensagemErro = 'Usuário não encontrado no banco de dados.';
              } else if (resposta.code === 'ConditionalCheckFailedException') {
                mensagemErro = 'Dados do usuário podem ter sido alterados. Recarregue a página.';
              }
              
              mostrarNotificacao('Erro!', `Não foi possível mover o usuário: ${mensagemErro}`, 'danger');
            } catch (e) {
              // Fallback para mensagem genérica se não conseguir analisar a resposta
              mostrarNotificacao('Erro!', `Não foi possível mover o usuário. Verifique o console para detalhes. [${status}: ${error}]`, 'danger');
            }
          }
        });
      }
      
      // Função para mostrar notificações
      function mostrarNotificacao(titulo, mensagem, tipo = 'info') {
        const notificacaoId = 'notificacao-' + Date.now();
        const html = `
          <div id="${notificacaoId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="5000">
            <div class="toast-header bg-${tipo} text-white">
              <strong class="mr-auto">${titulo}</strong>
              <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Fechar">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="toast-body">
              ${mensagem}
            </div>
          </div>
        `;
        
        // Verificar se o container de notificações existe, senão criar
        if ($('#notificacoes-container').length === 0) {
          $('body').append(`
            <div id="notificacoes-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
          `);
        }
        
        // Adicionar notificação ao container
        $('#notificacoes-container').append(html);
        
        // Mostrar a notificação
        $(`#${notificacaoId}`).toast('show');
        
        // Remover a notificação do DOM quando fechada
        $(`#${notificacaoId}`).on('hidden.bs.toast', function() {
          $(this).remove();
        });
      }
      
      // Carregar dados iniciais
      loadUsuarios();
      loadConteudos();
      loadKanbanData();
      loadDashboards();
      loadPerfisUsuarios();
      
      // Configurar eventos de atualização
      $('#refreshUsuarios').click(loadUsuarios);
      $('#refreshConteudos').click(loadConteudos);
      $('#refreshKanban').click(loadKanbanData);
      $('#refreshDashboards').click(loadDashboards);
      $('#refreshPerfis').click(loadPerfisUsuarios);
      
      // Tratar cliques em abas
      $('#adminTabs a').on('click', function (e) {
        e.preventDefault();
        $(this).tab('show');
      });
    });
  </script>
</body>
</html>
